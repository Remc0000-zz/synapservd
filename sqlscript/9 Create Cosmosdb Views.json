{
	"name": "9 Create Cosmosdb Views",
	"properties": {
		"content": {
			"query": "CREATE OR ALTER VIEW RetailSales\nAS \n\tSELECT\n\t\tproductcode, quantity, price,quantity*price as revenue, advertising, CAST(storeId as varchar(3)) as storeId, CAST(weekStarting AS datetime) weekStarting\n\tFROM OPENROWSET\n\t\t('CosmosDB','Account=cosmosdb-cdp-retail-prod;Database=RetailData;Key=K15ImI7azZxzIDClBT7nx42GJql35Ll1ZECm5QNSNsckWqMtEEm2yeUp1I3rvYbjzRrEcRwewono2UBq5Ez4UA==',RetailSales\n\t\t)\n\tWITH (\n\t\tproductcode varchar(15),\n\t\tquantity bigint,\n\t\tprice bigint,\n\t\tadvertising bigint,\n\t\tstoreId bigint,\n\t\tweekStarting varchar(20)\n\t) AS q1\nGO\n\nSELECT TOP(10) * FROM RetailSales \nGO\n\n\nCREATE OR ALTER VIEW Product\nAS \nSELECT\n\tproductcode, CAST(baseprice as float) as baseprice, productid, CAST(wholesalecost as float) as wholesalecost\nFROM OPENROWSET\n\t('CosmosDB','Account=cosmosdb-cdp-retail-prod;Database=RetailData;Key=K15ImI7azZxzIDClBT7nx42GJql35Ll1ZECm5QNSNsckWqMtEEm2yeUp1I3rvYbjzRrEcRwewono2UBq5Ez4UA==',Product\n\t\t)\nWITH (\n\tproductcode varchar(15),\n\tbaseprice varchar(7),\n\tproductid bigint,\n\twholesalecost varchar(6)\n) AS q1\nGO\n\nSELECT TOP(10) * FROM Product\nGO\n\n\n\nCREATE OR ALTER VIEW StoreDemographics\nAS \nSELECT\n\tincome, minoritiesRatio, largeHH, highIncome150Ratio, more1FullTimeEmployeeRatio, ratioAge60, salesNearestWarehousesRatio, CAST(storeId as varchar(3)) as storeId, salesNearest5StoresRatio, avgDistanceNearest5Supermarkets, distanceNearestWarehouse\nFROM OPENROWSET\n\t('CosmosDB','Account=cosmosdb-cdp-retail-prod;Database=RetailData;Key=K15ImI7azZxzIDClBT7nx42GJql35Ll1ZECm5QNSNsckWqMtEEm2yeUp1I3rvYbjzRrEcRwewono2UBq5Ez4UA==',StoreDemographics\n\t\t)\nWITH (\n\tincome float,\n\tminoritiesRatio float,\n\tlargeHH float,\n\thighIncome150Ratio float,\n\tmore1FullTimeEmployeeRatio float,\n\tratioAge60 float,\n\tsalesNearestWarehousesRatio float,\n\tstoreid bigint,\n\tsalesNearest5StoresRatio float,\n\tavgDistanceNearest5Supermarkets float,\n\tdistanceNearestWarehouse float\n) AS q1\nGO\n\nSELECT TOP(10) * FROM StoreDemographics\nGO\n\n\n\n-- SAMPLE QUERY\nSELECT TOP(100) a.storeId, b.productcode, b.wholesalecost, b.baseprice\n, c.ratioAge60, c.income, c.highIncome150Ratio, c.largeHH, c.minoritiesRatio, c.more1FullTimeEmployeeRatio\n, c.distanceNearestWarehouse, c.salesNearestWarehousesRatio, c.avgDistanceNearest5Supermarkets, c.salesNearest5StoresRatio\n, a.quantity, a.advertising, a.price, a.weekStarting\nFROM retailsales a\n\tLEFT JOIN product b\n\t\tON a.productcode = b.productcode\nLEFT JOIN storedemographics c\n\tON a.storeId = c.storeId\nORDER BY a.weekStarting, a.storeId\nGO\n\n\n\nCREATE OR ALTER VIEW POSTransactions\nAS \nSELECT\n\tId, OrderItems\nFROM OPENROWSET\n\t('CosmosDB','Account=cosmosdb-cdp-retail-prod;Database=RetailData;Key=K15ImI7azZxzIDClBT7nx42GJql35Ll1ZECm5QNSNsckWqMtEEm2yeUp1I3rvYbjzRrEcRwewono2UBq5Ez4UA==',POSTransactions\n\t\t)\nWITH (\n\tId varchar(50),\n\tOrderItems varchar(max)\n) AS q1\nGO\n\nSELECT TOP(10) * FROM POSTransactions\nGO\n\nCREATE OR ALTER VIEW POSTransactionDetails\nAS\nSELECT POSTransactions.Id ,ProductName, ProductId, Category, Quantity, Cost, UsedCoupon,\tCouponExpDate\n FROM POSTransactions\n  CROSS APPLY OPENJSON(OrderItems)  \n  WITH (\n    ProductName NVARCHAR(50) '$.ProductName',\n\tProductId INT '$.ProductId', \n\tCategory NVARCHAR(50)  '$.Category', \n    Quantity INT '$.Quantity',\n\tCost INT '$.Cost', \n\tUsedCoupon NVARCHAR(1) '$.UsedCoupon',\n\tCouponExpDate NVARCHAR(50) '$.CouponExpDate'\n  );\nGO\n\nSELECT TOP(10) * FROM POSTransactionDetails\nGO\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"name": "cosmosretailsales",
				"type": "SqlOnDemand"
			}
		},
		"type": "SqlQuery"
	}
}